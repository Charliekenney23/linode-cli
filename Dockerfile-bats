FROM python:2

ARG SPEC=https://developers.linode.com/api/docs/v4/openapi.yaml
ARG API_OVERRIDE=api.linode.com
ARG TOKEN_1
ARG TOKEN_2

RUN apt-get update && apt-get install -y python3 python3-pip bats parallel \
    && pip install requests terminaltables colorclass PyYAML enum34 \
    && pip3 install requests terminaltables colorclass PyYAML enum34

ENV PYTHONPATH=.
ENV PATH="/usr/local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.local/bin"
ENV DEFAULT_API="url: https://api.linode.com/v4"
ENV API_ENV="url: https://${API_OVERRIDE}/v4"

WORKDIR /src/linode-cli

COPY . .

# Modify the cli.py to suppress version warnings by default
# Modify the cli.py to no longer verify certs and suppress warnings (allows running tests on custom environments)
RUN sed -i="" "s/data=body/data=body,verify=False/" /src/linode-cli/linodecli/cli.py \
    && sed -i="" "s/suppress_warnings = False/suppress_warnings = True/" /src/linode-cli/linodecli/cli.py \
    && echo "from requests.packages.urllib3.exceptions import InsecureRequestWarning\nrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)" >> /src/linode-cli/linodecli/cli.py

# Build and Install the Linode CLI
RUN sed -n "s|${DEFAULT_API}|${API_ENV}|g;w cli-tests.yaml" /src/linode-cli/open-api.yaml \
    && git submodule init \
    && git submodule update \
    && make build SPEC=/src/linode-cli/cli-tests.yaml \
    && make install SPEC=/src/linode-cli/cli-tests.yaml \
    && cd dist \
    && pip install --user $(ls) \
    && echo -n "[DEFAULT]\ntoken = ${TOKEN_1}\ndefault-user = test-user\n\n[test-user]" > /root/.linode-cli \
    && echo "export TOKEN_1=$TOKEN_1" > /src/linode-cli/test/.env \
    && echo "export TOKEN_2=$TOKEN_2" >> /src/linode-cli/test/.env \
    && echo "export TOKEN_1_IN_USE_BY=NONE" >> /src/linode-cli/test/.env \
    && echo "export TOKEN_2_IN_USE_BY=NONE" >> /src/linode-cli/test/.env

WORKDIR /src

# Install BATS testing framework
RUN mkdir bats-core \
    && cd bats-core \
    && git clone https://github.com/bats-core/bats-core.git --branch master v1.1.0 --single-branch \
    && cd v1.1.0 \
    && ./install.sh /usr/local

WORKDIR /src/linode-cli

ENTRYPOINT ["test/test-runner.sh", "--force"]
